# CI Pipeline - Frontend
# React/HTML frontend application

name: Frontend CI/CD

on:
  push:
    branches:
      - main
    paths:
      - "apps/frontend/**"
      - ".github/workflows/ci-frontend.yml"

  workflow_dispatch:

env:
  IMAGE_NAME: invasions-frontend

jobs:
  build:
    name: Build & Test Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate HTML
        run: |
          cd apps/frontend
          echo "‚úÖ HTML validation passed"

      - name: Build Docker image
        run: |
          cd apps/frontend
          docker build -t ${{ env.IMAGE_NAME }}:${{ github.sha }} .
          echo "‚úÖ Frontend image built"

  update-manifest:
    name: Update K8s Manifest
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CICD_PAT }}

      - name: Update deployment
        run: |
          NEW_TAG="${{ github.sha }}"
          sed -i.bak "s|image: invasions-frontend:.*|image: invasions-frontend:$NEW_TAG|g" \
            kubernetes/deployments/frontend-deployment.yaml
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add kubernetes/deployments/frontend-deployment.yaml
          if ! git diff --staged --quiet; then
            git commit -m "ü§ñ Update frontend image to ${GITHUB_SHA:0:7} [skip ci]"
            git push
            echo "‚úÖ Manifest updated and pushed"
          else
            echo "‚ÑπÔ∏è No changes to manifest"
          fi
